What we changed (by area)
View selection (safe, env‑controlled)
Added AGENT_DATA_VIEW whitelist (agent_data_v2 default; fallback agent_data) and replaced all FROM agent_data with the selected view in stats, call‑details, KPIs, trends, and helper queries.
Code:
external-db.tsLines 37-40
const allowedAgentViews = new Set(['agent_data_v2', 'agent_data']);const envView = (process.env.AGENT_DATA_VIEW || '').trim();const AGENT_DATA_VIEW = allowedAgentViews.has(envView) ? envView : 'agent_data_v2';
Fix for undercount / missing rows
Stats and call‑details now dedupe with a robust key (falls back to contacts_id:contacts_campaign_id:transactions_fired_date if transaction_id is NULL).
Code:
external-db.tsLines 212-221
const uniqueExpr = `COALESCE(transaction_id::text, CONCAT_WS(':', contacts_id::text, contacts_campaign_id::text, transactions_fired_date::text))`SELECT DISTINCT ON (${uniqueExpr}) *...ORDER BY ${uniqueExpr},         COALESCE(recordings_started, recordings_start_time::timestamp, transactions_fired_date::timestamp) DESC NULLS LAST,         connections_duration DESC NULLS LAST
Campaign filter robustness
Campaign equality is now case‑insensitive and trimmed to avoid drops.
Code:
external-db.tsLines 200-207
LOWER(TRIM(contacts_campaign_id)) = LOWER(TRIM($2))
Time window semantics
Call‑details SQL now accepts a proper time window on a robust timestamp (COALESCE) and converts UI time to UTC. Full‑day “00:00–23:59” is treated as a no‑op; wrap‑around over midnight is supported.
Code:
external-db.tsLines 212-236
// full-day => no-op; wrap-around supported; zone Europe/Berlin
Time zone policy change (German time, DST‑aware)
All call‑details filtering and stats time conversion moved from “Cyprus +3” to “Europe/Berlin” (CET/CEST).
SQL conversion (stats loader) uses an offset resolver; post‑fetch filters compare local “HH:MM” in Europe/Berlin.
Code:
external-storage.tsLines 952-971
const offset = this.getBerlinOffsetHours(dateFrom || dateTo);const utcHours = (hours - offset + 24) % 24;
external-storage.tsLines 1243-1280
const localHHMM = this.toBerlinHHMM(detail.callStart);if (timeFrom && localHHMM < timeFrom) return false;if (timeTo && localHHMM > timeTo) return false;
Resilience to missing recordings timestamps
ORDER BY and mapping use COALESCE(recordings_started, recordings_start_time, transactions_fired_date) so calls without recordings still appear with correct sort and time filtering.
Code:
external-storage.tsLines 1191-1227
const startRaw = record.recordings_started || record.recordings_start_time || record.transactions_fired_date;const startDate = new Date(startRaw);
Frontend requests
Campaign detail page now posts dateFrom/dateTo plus default timeFrom: '00:00', timeTo: '23:59' to /api/call-details-by-project.
Code:
page.tsxLines 323-336
body: JSON.stringify({ projectId, agentIds, dateFrom, dateTo, timeFrom: timeFrom || '00:00', timeTo: timeTo || '23:59' })
Why we changed it (root issues)
Count/talk undercount vs UI/API originally
agent_data joined contacts via recordings; zero‑recording calls dropped → lower Count/Talk.
DISTINCT ON by transaction_id dropped rows where transaction_id is NULL or duplicated → further undercount.
Switching to agent_data_v2 and robust DISTINCT key fixed Count/Talk alignment.
“Individual calls” empty
Initially, the client didn’t send dateFrom/dateTo, so backend defaulted to “today”.
After the view switch, many rows had NULL recordings_started; sorting/filtering dependent on it produced drops.
Full‑day time window “00:00–23:59” + naive timezone conversion sometimes turned into an impossible UTC range → zero rows.
Fixes: client now sends dates, server tolerates NULL timestamps, full‑day treated as no‑op, wrap‑around handled.
Time zone mismatch
Original logic assumed Cyprus time; you asked to use German time (CET/CEST). SQL and post‑fetch filters now use Europe/Berlin correctly.
Current state (what’s working vs what’s not)
Working
Stats (agent/day) now read from agent_data_v2 (default), dedupe robustly, and include zero‑recording calls. Talk/Wait/NBZ/VBZ/AZ logic unchanged.
Call‑details ORDER BY and mapping are robust to NULL recording timestamps.
Client requests include dates and time window; backend treats full‑day as no‑op.
Still facing
For some payloads (e.g., campaign 6bf4570a-a8e7-6594-6af4-c2c6afe31bdf, 2025-11-13), call‑details return empty even though stats show calls. This suggests one (or more) of:
Campaign ID mismatch between our projectId → campaignId mapping and contacts_campaign_id in the view (case trimmed now; still could be wrong campaign for that project).
Agent logins mapped from agentIds don’t match transactions_user_login in those rows (we compare case‑insensitive; but some rows could be blank or variants not in agent_latest_last_2_months).
The day has transactions counted in stats (based on DISTINCT of transaction/contact/date) but no per‑agent rows for that precise contacts_campaign_id after dedupe (e.g., if campaign moved/renamed and mapping misaligns).
Date filter is OK, but the project being viewed is the resolved name while the SQL uses the original contacts_campaign_id (we do use original IDs, but this is the most common source of “looks right, returns 0”).